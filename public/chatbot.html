<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Chat with Calmora support bot">
    <title>Chat Support - Calmora</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Calmora">
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            min-height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: var(--bg-gray);
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border: 1px solid var(--border-color);
        }

        .message {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message.user {
            background: var(--primary-color);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: var(--shadow-sm);
        }

        .message.bot {
            background: var(--bg-white);
            color: var(--text-dark);
            align-self: flex-start;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
        }

        .chat-input-container .btn {
            min-width: 100px;
        }

        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 10px;
            align-self: flex-start;
            box-shadow: var(--shadow-sm);
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-light);
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo" style="display: flex; align-items: center; gap: 0.75rem;">
                <img src="favicon.svg" alt="Calmora Logo" style="width: 32px; height: 32px; flex-shrink: 0;">
                <span>Calmora</span>
            </a>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="therapists.html">Therapists</a></li>
                <li><a href="resources.html">Resources</a></li>
                <li><a href="mood-tracker.html">Mood Tracker</a></li>
                <li><a href="journal.html">Journal</a></li>
                <li><a href="chatbot.html">Chatbot</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="login.html" class="btn btn-secondary">Login</a></li>
            </ul>
            <div class="hamburger" aria-label="Toggle navigation menu">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
        <section class="section" style="padding: 3rem 0;">
            <div class="container">
                <div style="max-width: 900px; margin: 0 auto;">
                    <h1 class="section-title">Chat Support</h1>
                    <p style="text-align: center; color: var(--text-medium); margin-bottom: 3rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                        Get instant support and guidance from our AI assistant. For emergencies, please contact crisis helplines immediately.
                    </p>

                    <div class="card chat-container" style="padding: 1.5rem;">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message bot">
                                <p style="margin: 0;">Hello! I'm here to provide gentle, supportive mental health guidance. I'm not a medical professional, but I can listen and offer helpful resources. For emergencies or immediate crisis, please contact crisis helplines at 988 or text HOME to 741741.</p>
                            </div>
                        </div>
                        <div class="typing-indicator" id="typingIndicator">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input 
                                type="text" 
                                id="chatInput" 
                                class="form-control chat-input" 
                                placeholder="Type your message..."
                                autocomplete="off"
                            >
                            <button type="button" class="btn" id="sendBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Calmora. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="theme-toggle.js"></script>
    <script src="image-fallback.js"></script>
    <script src="background-slideshow.js"></script>
    <script src="helpers.js"></script>
    <script src="api.js"></script>
    <script src="auth.js"></script>
    <script src="permissions.js"></script>
    <script src="user-info.js"></script>
    <script src="main.js"></script>
    <script>
        // Chatbot functionality
        (function() {
            'use strict';

            document.addEventListener('DOMContentLoaded', function() {
                const chatMessages = document.getElementById('chatMessages');
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                const typingIndicator = document.getElementById('typingIndicator');

                // Keyword-based response patterns
                const responses = {
                    'stress': 'Stress can be overwhelming. Try deep breathing exercises, take breaks, prioritize tasks, and talk to someone you trust. Would you like resources on stress management?',
                    'depression': 'Depression is a serious condition. Please reach out to a mental health professional. You can find therapists on our platform or contact crisis helplines. You\'re not alone.',
                    'anxiety': 'Anxiety can feel overwhelming. Try grounding techniques like the 5-4-3-2-1 method, deep breathing, or mindfulness. Would you like to learn more coping strategies?',
                    'help': 'I\'m here to help! I can provide information about mental health topics. For professional help, please visit our resources page or contact a therapist. For emergencies, call 988.',
                    'suicide': 'If you\'re having thoughts of suicide, please contact the National Suicide Prevention Lifeline at 988 immediately. You matter and help is available 24/7.',
                    'crisis': 'For mental health crises, contact: National Suicide Prevention Lifeline at 988, or Crisis Text Line by texting HOME to 741741. Help is available 24/7.',
                    'therapy': 'Therapy can be very helpful. Check out our therapist directory or resources page for information. Many therapists offer online sessions.',
                    'sleep': 'Sleep is crucial for mental health. Try maintaining a regular sleep schedule, avoiding screens before bed, and creating a relaxing bedtime routine.',
                    'hello': 'Hello! How can I help you today? Try keywords like "stress", "depression", "anxiety", or "help" for specific information.',
                    'hi': 'Hi there! I\'m a simple support bot. Type keywords like "stress", "depression", or "help" to get started.',
                };

                function addMessage(text, isUser = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
                    messageDiv.innerHTML = `<p style="margin: 0;">${text}</p>`;
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                function getBotResponse(userMessage) {
                    const lowerMessage = userMessage.toLowerCase();
                    
                    // Check for keyword matches
                    for (const [keyword, response] of Object.entries(responses)) {
                        if (lowerMessage.includes(keyword)) {
                            return response;
                        }
                    }

                    // Default responses
                    const defaultResponses = [
                        'I understand. Can you tell me more about that?',
                        'That sounds difficult. How does that make you feel?',
                        'Thank you for sharing. What would be helpful for you right now?',
                        'I\'m here to listen. Would you like to explore some coping strategies?',
                        'That\'s important. Have you considered speaking with a therapist about this?',
                    ];

                    return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
                }

                async function sendMessage() {
                    const message = chatInput.value.trim();
                    if (!message) return;

                    // Add user message
                    addMessage(message, true);
                    const userMessage = message;
                    chatInput.value = '';
                    chatInput.disabled = true;
                    sendBtn.disabled = true;

                    // Show typing indicator
                    typingIndicator.classList.add('active');
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    try {
                        // Check if API is available
                        if (!window.API || !window.API.chat) {
                            throw new Error('API not loaded. Please refresh the page.');
                        }

                        // Check network permissions
                        if (window.Permissions && !window.Permissions.status.network) {
                            // Request network access if not granted
                            const networkAccess = await window.Permissions.requestNetwork();
                            if (!networkAccess) {
                                throw new Error('Network access is required for the chatbot to work. Please allow network access.');
                            }
                        }

                        // Get AI response from OpenRouter
                        const result = await window.API.chat.send(userMessage);
                        
                        // Handle response - backend returns { success: true, reply: "..." }
                        if (result && result.success && result.reply) {
                            typingIndicator.classList.remove('active');
                            addMessage(result.reply);
                            
                            // Store chat log to API (silently fail if it doesn't work)
                            window.API.messages.save({
                                message: userMessage,
                                response: result.reply
                            }).catch(error => {
                                console.error('Error saving chat log:', error);
                                // Fallback to localStorage if API fails
                                try {
                                    const chatLog = {
                                        message: userMessage,
                                        response: result.reply,
                                        created_at: new Date().toISOString()
                                    };
                                    const chatLogs = JSON.parse(localStorage.getItem('chatLogs') || '[]');
                                    chatLogs.push(chatLog);
                                    localStorage.setItem('chatLogs', JSON.stringify(chatLogs));
                                } catch (e) {
                                    console.error('Error saving to localStorage:', e);
                                }
                            });
                        } else {
                            // Unexpected response format
                            throw new Error('Unexpected response format from server');
                        }
                    } catch (error) {
                        typingIndicator.classList.remove('active');
                        console.error('Chat error:', error);
                        
                        // Extract error message
                        let errorMessage = 'Unknown error occurred';
                        if (error.message) {
                            errorMessage = error.message;
                        } else if (error.error) {
                            errorMessage = error.error;
                        }
                        
                        // Show user-friendly error message
                        const userFriendlyError = errorMessage.includes('Network error') || 
                                                 errorMessage.includes('Unable to connect') ||
                                                 errorMessage.includes('temporarily unavailable') ||
                                                 errorMessage.includes('timeout')
                            ? 'Unable to connect to the AI service. Please check your internet connection and try again.'
                            : 'The AI service encountered an error. Using a basic response instead.';
                        
                        // Fallback to keyword-based response
                        const fallbackResponse = getBotResponse(userMessage);
                        addMessage(fallbackResponse);
                        
                        // Show error notification (but not too intrusive)
                        if (errorMessage && !errorMessage.includes('I understand') && !errorMessage.includes('That sounds')) {
                            console.warn('AI service error:', errorMessage);
                            // Only show error message if it's a real error, not a keyword match
                            if (!fallbackResponse.includes('I understand') && !fallbackResponse.includes('That sounds')) {
                                setTimeout(() => {
                                    addMessage('ðŸ’¡ Note: AI service is temporarily unavailable. Showing a helpful response based on your message.');
                                }, 500);
                            }
                        }
                    } finally {
                        chatInput.disabled = false;
                        sendBtn.disabled = false;
                        chatInput.focus();
                    }
                }

                // Event listeners
                sendBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            });
        })();
    </script>
</body>
</html>

