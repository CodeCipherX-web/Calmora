<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Track your mood with Calmora">
    <title>Mood Tracker - Calmora</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Calmora">
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo" style="display: flex; align-items: center; gap: 0.75rem;">
                <img src="favicon.svg" alt="Calmora Logo" style="width: 32px; height: 32px; flex-shrink: 0;">
                <span>Calmora</span>
            </a>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="therapists.html">Therapists</a></li>
                <li><a href="resources.html">Resources</a></li>
                <li><a href="mood-tracker.html">Mood Tracker</a></li>
                <li><a href="journal.html">Journal</a></li>
                <li><a href="chatbot.html">Chatbot</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="login.html" class="btn btn-secondary">Login</a></li>
            </ul>
            <div class="hamburger" aria-label="Toggle navigation menu">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
        <section class="section" style="padding: 3rem 0;">
            <div class="container">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h1 class="section-title">Mood Tracker</h1>
                    <p style="text-align: center; color: var(--text-medium); margin-bottom: 3rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                        Track your daily moods and emotions to better understand your mental health patterns over time.
                    </p>

                    <!-- Today's Mood Entry -->
                    <div class="card" style="margin-bottom: 2.5rem;">
                        <div style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">How are you feeling today?</h3>
                            <form id="moodForm">
                                <div class="form-group">
                                    <label for="moodLevel" style="display: block; margin-bottom: 1rem; font-weight: 600; color: var(--text-dark);">Select your mood level (1-5):</label>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                                        <button type="button" class="mood-btn" data-mood="1" style="padding: 1.25rem 0.75rem; border: 1.5px solid var(--border-color); background: var(--bg-white); border-radius: 8px; cursor: pointer; transition: var(--transition-fast); font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90px;">
                                            <span style="font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--error-color);">1</span>
                                            <small style="font-size: 0.75rem; color: var(--text-medium);">Very Low</small>
                                        </button>
                                        <button type="button" class="mood-btn" data-mood="2" style="padding: 1.25rem 0.75rem; border: 1.5px solid var(--border-color); background: var(--bg-white); border-radius: 8px; cursor: pointer; transition: var(--transition-fast); font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90px;">
                                            <span style="font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--warning-color);">2</span>
                                            <small style="font-size: 0.75rem; color: var(--text-medium);">Low</small>
                                        </button>
                                        <button type="button" class="mood-btn" data-mood="3" style="padding: 1.25rem 0.75rem; border: 1.5px solid var(--border-color); background: var(--bg-white); border-radius: 8px; cursor: pointer; transition: var(--transition-fast); font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90px;">
                                            <span style="font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--secondary-color);">3</span>
                                            <small style="font-size: 0.75rem; color: var(--text-medium);">Neutral</small>
                                        </button>
                                        <button type="button" class="mood-btn" data-mood="4" style="padding: 1.25rem 0.75rem; border: 1.5px solid var(--border-color); background: var(--bg-white); border-radius: 8px; cursor: pointer; transition: var(--transition-fast); font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90px;">
                                            <span style="font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--accent-color);">4</span>
                                            <small style="font-size: 0.75rem; color: var(--text-medium);">Good</small>
                                        </button>
                                        <button type="button" class="mood-btn" data-mood="5" style="padding: 1.25rem 0.75rem; border: 1.5px solid var(--border-color); background: var(--bg-white); border-radius: 8px; cursor: pointer; transition: var(--transition-fast); font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90px;">
                                            <span style="font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--success-color);">5</span>
                                            <small style="font-size: 0.75rem; color: var(--text-medium);">Excellent</small>
                                        </button>
                                    </div>
                                    <input type="hidden" id="selectedMood" name="mood_level" required>
                                </div>

                                <div class="form-group">
                                    <label for="moodNotes" style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-dark);">Notes (optional)</label>
                                    <textarea 
                                        id="moodNotes" 
                                        name="notes" 
                                        class="form-control" 
                                        rows="4"
                                        placeholder="What's affecting your mood today?"
                                    ></textarea>
                                </div>

                                <button type="submit" class="btn" style="width: 100%; margin-top: 1.5rem;">Save Mood Entry</button>
                            </form>
                        </div>
                    </div>

                    <!-- Mood Chart -->
                    <div class="card" style="margin-bottom: 2.5rem;">
                        <div style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">Your Mood Trends</h3>
                            <div style="position: relative; height: 350px;">
                                <canvas id="moodChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Mood History -->
                    <div class="card">
                        <div style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">Your Mood History</h3>
                            <div id="moodHistory">
                                <p style="text-align: center; color: var(--text-light); padding: 2rem 0;">No mood entries yet. Start tracking your mood today!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Calmora. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="theme-toggle.js"></script>
    <script src="image-fallback.js"></script>
    <script src="background-slideshow.js"></script>
    <script src="helpers.js"></script>
    <script src="api.js"></script>
    <script src="auth.js"></script>
    <script src="permissions.js"></script>
    <script src="user-info.js"></script>
    <script src="main.js"></script>
    <script>
        // Mood tracker functionality
        (function() {
            'use strict';

            document.addEventListener('DOMContentLoaded', function() {
                const moodButtons = document.querySelectorAll('.mood-btn');
                const selectedMoodInput = document.getElementById('selectedMood');
                const moodForm = document.getElementById('moodForm');

                // Handle mood button clicks
                moodButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // Remove active class from all buttons
                        moodButtons.forEach(btn => {
                            btn.style.borderColor = 'var(--border-color)';
                            btn.style.background = 'var(--bg-white)';
                            btn.style.boxShadow = 'none';
                        });

                        // Add active class to clicked button
                        this.style.borderColor = 'var(--primary-color)';
                        this.style.background = 'rgba(37, 99, 235, 0.05)';
                        this.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.1)';
                        
                        // Set selected mood
                        selectedMoodInput.value = this.dataset.mood;
                    });
                });

                // Handle form submission
                if (moodForm) {
                    moodForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        if (!selectedMoodInput.value) {
                            alert('Please select a mood');
                            return;
                        }

                        const formData = new FormData(moodForm);
                        const moodData = {
                            mood_level: parseInt(formData.get('mood_level')),
                            notes: formData.get('notes') || null,
                        };

                        try {
                            // Save to API if authenticated, otherwise use localStorage
                            if (window.Helpers.isAuthenticated()) {
                                await window.API.moods.save(moodData);
                            } else {
                                // Fallback to localStorage for guests
                                moodData.created_at = new Date().toISOString();
                                const moodEntries = JSON.parse(localStorage.getItem('moodEntries') || '[]');
                                moodEntries.unshift(moodData);
                                localStorage.setItem('moodEntries', JSON.stringify(moodEntries));
                            }

                            // Show success message
                            alert('Mood entry saved successfully!');
                            
                            // Reset form
                            moodForm.reset();
                            moodButtons.forEach(btn => {
                                btn.style.borderColor = 'var(--border-color)';
                                btn.style.background = 'var(--bg-white)';
                                btn.style.boxShadow = 'none';
                            });

                            // Refresh mood history and chart
                            displayMoodHistory();
                            updateMoodChart();
                        } catch (error) {
                            console.error('Error saving mood:', error);
                            alert('Error saving mood entry. Please try again.');
                        }
                    });
                }

                // Chart.js setup
                let moodChart = null;

                async function updateMoodChart() {
                    let moodEntries = [];
                    
                    // Load from API if authenticated, otherwise use localStorage
                    if (window.Helpers.isAuthenticated()) {
                        try {
                            const result = await window.API.moods.getAll();
                            moodEntries = result.moods || [];
                        } catch (error) {
                            console.error('Error loading moods:', error);
                            moodEntries = JSON.parse(localStorage.getItem('moodEntries') || '[]');
                        }
                    } else {
                        moodEntries = JSON.parse(localStorage.getItem('moodEntries') || '[]');
                    }
                    
                    const ctx = document.getElementById('moodChart');
                    if (!ctx) return;

                    // Prepare data for chart (last 30 days or all entries)
                    const sortedEntries = moodEntries
                        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
                        .slice(-30);
                    
                    const labels = sortedEntries.map(entry => {
                        const date = new Date(entry.created_at);
                        return window.Helpers.formatDate(date, 'MM/DD');
                    });
                    
                    const moodLevels = sortedEntries.map(entry => entry.mood_level || entry.mood);

                    if (moodChart) {
                        moodChart.destroy();
                    }

                    if (sortedEntries.length === 0) {
                        ctx.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No mood data yet. Start tracking to see your mood trends!</p>';
                        return;
                    }

                    moodChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Mood Level',
                                data: moodLevels,
                                borderColor: 'rgb(37, 99, 235)',
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: 'rgb(37, 99, 235)',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    min: 1,
                                    max: 5,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'Mood Level (1-5)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            }
                        }
                    });
                }

                // Display mood history
                async function displayMoodHistory() {
                    const moodHistory = document.getElementById('moodHistory');
                    let moodEntries = [];
                    
                    // Load from API if authenticated, otherwise use localStorage
                    if (window.Helpers.isAuthenticated()) {
                        try {
                            const result = await window.API.moods.getAll();
                            moodEntries = result.moods || [];
                        } catch (error) {
                            console.error('Error loading moods:', error);
                            moodEntries = JSON.parse(localStorage.getItem('moodEntries') || '[]');
                        }
                    } else {
                        moodEntries = JSON.parse(localStorage.getItem('moodEntries') || '[]');
                    }

                    if (moodEntries.length === 0) {
                        moodHistory.innerHTML = '<p style="text-align: center; color: var(--text-light);">No mood entries yet. Start tracking your mood today!</p>';
                        return;
                    }

                    let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                    moodEntries.slice(0, 10).forEach(entry => {
                        const date = new Date(entry.created_at || entry.date);
                        const moodLevel = entry.mood_level || entry.mood;
                        const moodLabels = {
                            1: 'Very Low',
                            2: 'Low',
                            3: 'Neutral',
                            4: 'Good',
                            5: 'Excellent'
                        };
                        const moodColors = {
                            1: 'var(--error-color)',
                            2: 'var(--warning-color)',
                            3: 'var(--secondary-color)',
                            4: 'var(--accent-color)',
                            5: 'var(--success-color)'
                        };
                        html += `
                            <div style="padding: 1.25rem; background: var(--bg-gray); border: 1px solid var(--border-color); border-radius: 8px; transition: var(--transition-fast);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${entry.notes ? '0.75rem' : '0'};">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="width: 48px; height: 48px; border-radius: 8px; background: ${moodColors[moodLevel] || 'var(--primary-color)'}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 700;">
                                            ${moodLevel}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">${moodLabels[moodLevel] || 'Unknown'}</div>
                                            <div style="color: var(--text-light); font-size: 0.875rem;">${window.Helpers.formatDate(date, 'MMM DD, YYYY')}</div>
                                        </div>
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.875rem;">${window.Helpers.formatDate(date, 'h:mm A')}</div>
                                </div>
                                ${entry.notes ? `<p style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); color: var(--text-medium); line-height: 1.6;">${entry.notes}</p>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    moodHistory.innerHTML = html;
                }

                // Initial load
                (async () => {
                    await displayMoodHistory();
                    await updateMoodChart();
                })();
            });
        })();
    </script>
</body>
</html>

